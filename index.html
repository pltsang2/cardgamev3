<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¥µè‡´è³€å¡è£½ä½œæ©Ÿ (Phaserå¼•æ“ç‰ˆ)</title>
    
    <!-- App å½è£æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- 1. å¼•å…¥ Phaser 3 éŠæˆ²å¼•æ“ (ä¾†è‡ª CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* é–‹å§‹ç•«é¢ (HTML å±¤) - ç‚ºäº†è™•ç†éŸ³æ•ˆè§£é– */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            transition: opacity 0.5s;
        }
        .btn-start {
            font-size: 2rem; padding: 15px 40px; border-radius: 50px;
            background: #fff; color: #333; border: none; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 20px rgba(255,255,255,0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <!-- HTML UI å±¤ï¼šé–‹å§‹æŒ‰éˆ• -->
    <div id="start-overlay">
        <h1 style="font-size: 3rem; text-shadow: 0 5px 10px rgba(0,0,0,0.5);">âœ¨ é­”æ³•è³€å¡è£½ä½œæ©Ÿ âœ¨</h1>
        <p style="font-size: 1.2rem; opacity: 0.8; margin-bottom: 30px;">è«‹è§£é™¤éœéŸ³ä»¥ç²å¾—æœ€ä½³é«”é©—</p>
        <button class="btn-start" onclick="startGame()">é–‹å§‹é«”é©— â–¶ï¸</button>
    </div>

    <!-- éŠæˆ²å®¹å™¨ -->
    <div id="game-container"></div>

<script>
    // --- å…¨å±€è®Šæ•¸ ---
    let game;
    let bgMusic = null;
    let currentThemeKey = 'christmas';
    
    // --- è³‡æ–™åº« ---
    const THEMES = {
        'christmas': {
            name: 'è–èª•å¿«æ¨‚', color: 0x2e7d32, bgColor: 0xe8f5e9,
            music: 'https://ia800504.us.archive.org/13/items/JingleBells_208/JingleBells.mp3',
            stickers: ['ğŸ…', 'ğŸ„', 'â›„', 'ğŸ¦Œ', 'ğŸ', 'â„ï¸', 'ğŸ””', 'ğŸª', 'ğŸ§¦', 'â­', 'ğŸ‘¼', 'ğŸ¡']
        },
        'newyear': {
            name: 'æ–°å¹´å¿«æ¨‚', color: 0xd32f2f, bgColor: 0xffcdd2,
            music: 'https://ia801601.us.archive.org/6/items/ChineseNewYearMusic/Chinese%20New%20Year%20Music.mp3',
            stickers: ['ğŸ§§', 'ğŸ®', 'ğŸ§¨', 'ğŸŠ', 'ğŸ¦', 'âœ¨', 'ğŸ‰', 'ğŸ’°', 'ğŸŒ¸', 'ğŸ¥Ÿ', 'ğŸŸ', 'ğŸ–Œï¸']
        },
        'birthday': {
            name: 'ç”Ÿæ—¥å¿«æ¨‚', color: 0x7b1fa2, bgColor: 0xf3e5f5,
            music: 'https://ia800806.us.archive.org/19/items/HappyBirthdayToYou_442/Happy_Birthday_to_You.mp3',
            stickers: ['ğŸ‚', 'ğŸˆ', 'ğŸ‰', 'ğŸ•¯ï¸', 'ğŸ‘‘', 'ğŸ', 'ğŸ°', 'ğŸ¥³', 'ğŸ§', 'ğŸ•', 'ğŸ­', 'ğŸ§¸']
        }
    };

    // --- å•Ÿå‹•éŠæˆ² ---
    function startGame() {
        const overlay = document.getElementById('start-overlay');
        overlay.style.opacity = 0;
        setTimeout(() => overlay.remove(), 500);

        // åˆå§‹åŒ–èªéŸ³
        const u = new SpeechSynthesisUtterance(" ");
        window.speechSynthesis.speak(u);

        // å•Ÿå‹• Phaser
        initPhaser();
    }

    // --- èªéŸ³åˆæˆ ---
    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-HK'; u.rate = 1.0; u.pitch = 1.2;
        const voices = window.speechSynthesis.getVoices();
        const hk = voices.find(v => v.lang.includes('zh-HK') || v.lang.includes('Cantonese'));
        if(hk) u.voice = hk;
        window.speechSynthesis.speak(u);
    }

    // --- Phaser éŠæˆ²é‚è¼¯ ---
    function initPhaser() {
        const config = {
            type: Phaser.AUTO,
            scale: {
                mode: Phaser.Scale.RESIZE, // è‡ªå‹•é©æ‡‰è¢å¹•å¤§å°
                parent: 'game-container',
                width: '100%', height: '100%'
            },
            backgroundColor: '#ffffff',
            scene: [MainScene]
        };
        game = new Phaser.Game(config);
    }

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            // é€™è£¡æˆ‘å€‘ä¸åŠ è¼‰åœ–ç‰‡ï¼Œè€Œæ˜¯ç”¨ä»£ç¢¼ç”Ÿæˆåœ–ç‰‡ï¼Œé€™æ¨£æ‰èƒ½ä¿æŒå–®ä¸€æª”æ¡ˆ
            this.load.audio('xmas_bgm', THEMES.christmas.music);
            this.load.audio('ny_bgm', THEMES.newyear.music);
            this.load.audio('bday_bgm', THEMES.birthday.music);
        }

        create() {
            this.stickersGroup = this.add.group(); // å­˜æ”¾è³€å¡ä¸Šçš„è²¼ç´™
            this.uiGroup = this.add.group();       // å­˜æ”¾ UI å…ƒç´ 

            // 1. å»ºç«‹å‹•æ…‹ç´‹ç† (Emoji -> åœ–ç‰‡)
            this.createEmojiTextures();
            this.createPatternTextures();

            // 2. ä½ˆå±€åˆå§‹åŒ–
            this.createLayout();

            // 3. ç²’å­ç³»çµ±åˆå§‹åŒ–
            this.particles = this.add.particles('particle_white'); // é è¨­ç™½è‰²ç²’å­
            this.emitter = this.particles.createEmitter({
                x: { min: 0, max: this.scale.width },
                y: -50,
                lifespan: 5000,
                speedY: { min: 50, max: 150 },
                scale: { start: 0.4, end: 0 },
                quantity: 2,
                blendMode: 'ADD'
            });

            // 4. è¨­å®šåˆå§‹ä¸»é¡Œ
            this.changeTheme('christmas');

            // 5. è™•ç†è¦–çª—æ”¹è®Šå¤§å°
            this.scale.on('resize', this.resize, this);
        }

        // --- æ ¸å¿ƒï¼šå‹•æ…‹ç”Ÿæˆç´ æ (è§£æ±ºç„¡åœ–æª”å•é¡Œ) ---
        createEmojiTextures() {
            // ç²’å­ç´ æ
            const gfx = this.make.graphics({x:0, y:0, add:false});
            gfx.fillStyle(0xffffff); gfx.fillCircle(16,16,16);
            gfx.generateTexture('particle_white', 32, 32);
            
            // å°‡æ‰€æœ‰ Emoji è½‰ç‚ºç´‹ç†
            Object.values(THEMES).forEach(theme => {
                theme.stickers.forEach(emoji => {
                    if(!this.textures.exists(emoji)) {
                        const canvas = document.createElement('canvas');
                        canvas.width = 128; canvas.height = 128;
                        const ctx = canvas.getContext('2d');
                        ctx.font = '100px serif';
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        ctx.fillText(emoji, 64, 64);
                        this.textures.addCanvas(emoji, canvas);
                    }
                });
            });
        }

        createPatternTextures() {
            // è–èª•æ–œç´‹
            const canvasX = document.createElement('canvas'); canvasX.width = 64; canvasX.height = 64;
            const ctxX = canvasX.getContext('2d');
            ctxX.fillStyle = '#e8f5e9'; ctxX.fillRect(0,0,64,64);
            ctxX.strokeStyle = '#c8e6c9'; ctxX.lineWidth = 10;
            ctxX.beginPath(); ctxX.moveTo(0,64); ctxX.lineTo(64,0); ctxX.stroke();
            this.textures.addCanvas('pattern_xmas', canvasX);

            // ç”Ÿæ—¥æ³¢é»
            const canvasB = document.createElement('canvas'); canvasB.width = 64; canvasB.height = 64;
            const ctxB = canvasB.getContext('2d');
            ctxB.fillStyle = '#f3e5f5'; ctxB.fillRect(0,0,64,64);
            ctxB.fillStyle = '#e1bee7'; ctxB.beginPath(); ctxB.arc(32,32,10,0,Math.PI*2); ctxB.fill();
            this.textures.addCanvas('pattern_bday', canvasB);
        }

        createLayout() {
            const w = this.scale.width;
            const h = this.scale.height;

            // èƒŒæ™¯åœ–å±¤
            this.bgTile = this.add.tileSprite(w/2, h/2, w, h, 'pattern_xmas');
            
            // é ‚éƒ¨æŒ‰éˆ•æ¬„
            this.createTopBar();

            // å·¦å´é¸å–®èƒŒæ™¯ (åŠé€æ˜)
            this.sidebarBg = this.add.rectangle(0, 80, w*0.25, h-80, 0xffffff, 0.9).setOrigin(0,0);
            this.sidebarBorder = this.add.rectangle(w*0.25, 80, 5, h-80, 0xcccccc).setOrigin(0,0);
            
            // æ¨™é¡Œæ–‡å­—
            this.greetingText = this.add.text(w * 0.6, h * 0.5, 'MERRY\nCHRISTMAS', {
                fontFamily: 'Arial Black', fontSize: '80px', color: '#2e7d32', align: 'center'
            }).setOrigin(0.5).setAlpha(0.3); // åŠé€æ˜èƒŒæ™¯å­—

            // è²¼ç´™é¸å–®å®¹å™¨
            this.paletteContainer = this.add.container(0, 100);
        }

        createTopBar() {
            const bar = this.add.rectangle(0, 0, this.scale.width, 80, 0xffffff).setOrigin(0,0);
            bar.setInteractive(); // é˜»æ“‹é»æ“Šç©¿é€
            
            // ä¸‰å€‹æŒ‰éˆ•
            this.createThemeBtn(100, 40, 'è–èª•å¡', 0x2e7d32, 'christmas');
            this.createThemeBtn(300, 40, 'æ–°å¹´å¡', 0xd32f2f, 'newyear');
            this.createThemeBtn(500, 40, 'ç”Ÿæ—¥å¡', 0x7b1fa2, 'birthday');
            
            // æ¸…é™¤æŒ‰éˆ•
            this.add.text(this.scale.width - 100, 40, 'ğŸ—‘ï¸ æ¸…é™¤', { 
                fontSize: '24px', color: '#333', backgroundColor: '#eee', padding: {x:10, y:5} 
            })
            .setOrigin(0.5)
            .setInteractive({useHandCursor: true})
            .on('pointerdown', () => {
                this.stickersGroup.clear(true, true); // æ¸…é™¤æ‰€æœ‰è²¼ç´™
                speak('æ¸…é™¤é‡ä¾†');
            });
        }

        createThemeBtn(x, y, text, color, themeKey) {
            const btn = this.add.rectangle(x, y, 160, 50, color, 1).setInteractive({useHandCursor: true});
            const txt = this.add.text(x, y, text, { fontSize: '20px', fontStyle: 'bold' }).setOrigin(0.5);
            
            // æŒ‰éˆ•ç‰¹æ•ˆ
            btn.on('pointerdown', () => {
                this.tweens.add({ targets: [btn, txt], scaleX: 0.9, scaleY: 0.9, duration: 100, yoyo: true });
                this.changeTheme(themeKey);
            });
        }

        // --- æ ¸å¿ƒï¼šåˆ‡æ›ä¸»é¡Œé‚è¼¯ ---
        changeTheme(key) {
            currentThemeKey = key;
            const data = THEMES[key];
            
            // 1. æ’­æ”¾éŸ³æ¨‚
            if(bgMusic) bgMusic.stop();
            // å°æ‡‰çš„ key: xmas_bgm, ny_bgm...
            let musicKey = key === 'christmas' ? 'xmas_bgm' : (key === 'newyear' ? 'ny_bgm' : 'bday_bgm');
            bgMusic = this.sound.add(musicKey, { loop: true, volume: 0.5 });
            bgMusic.play();

            // 2. æ”¹è®ŠèƒŒæ™¯èˆ‡æ–‡å­—
            this.greetingText.setText(data.name.replace(' ', '\n'));
            this.greetingText.setColor('#' + data.color.toString(16));
            
            if(key === 'christmas') this.bgTile.setTexture('pattern_xmas');
            else if(key === 'birthday') this.bgTile.setTexture('pattern_bday');
            else this.bgTile.setTexture('pattern_xmas').setTint(0xffcdd2); // æ–°å¹´ç”¨ç´…è‰²æŸ“è‰²çš„ç´‹ç†

            // 3. æ”¹è®Šç²’å­ç‰¹æ•ˆ
            this.updateParticles(key);

            // 4. é‡å»ºå·¦å´é¸å–®
            this.paletteContainer.removeAll(true);
            
            let row = 0;
            let col = 0;
            const startX = 60;
            const startY = 0;
            const gapX = 120;
            const gapY = 120;

            data.stickers.forEach((emoji, index) => {
                // åœ¨é¸å–®å»ºç«‹è²¼ç´™
                const sticker = this.add.image(startX + col * gapX, startY + row * gapY, emoji);
                sticker.setScale(0.8);
                sticker.setInteractive({ useHandCursor: true });

                // é»æ“Šäº‹ä»¶ï¼šç”Ÿæˆåˆ°å¡ç‰‡å€
                sticker.on('pointerdown', (pointer) => {
                    this.spawnSticker(emoji, pointer.x, pointer.y);
                    speak(data.name); // ç°¡å–®è®€å‡ºä¸»é¡Œåï¼Œæˆ–è€…å¯ä»¥æ›´ç´°
                    
                    // é¸å–®æŒ‰éˆ•å›é¥‹å‹•ç•«
                    this.tweens.add({ targets: sticker, scale: 0.6, duration: 50, yoyo: true });
                });

                this.paletteContainer.add(sticker);

                col++;
                if (col > 1) { col = 0; row++; }
            });
            
            speak(data.name);
        }

        updateParticles(theme) {
            // é‡ç½®
            this.emitter.stop();
            
            if (theme === 'christmas') {
                // é›ªèŠ±
                this.emitter.setTexture('particle_white');
                this.emitter.setSpeedY({ min: 50, max: 150 });
                this.emitter.setGravityY(0);
                this.emitter.setLifespan(5000);
                this.emitter.setScale({ start: 0.4, end: 0 });
                this.emitter.start();
            } else if (theme === 'newyear') {
                // ç…™ç«ç«èŠ±
                this.emitter.setTexture('particle_white');
                this.emitter.setPosition(this.scale.width/2, this.scale.height/2);
                this.emitter.setSpeed({ min: 100, max: 300 });
                this.emitter.setGravityY(200);
                this.emitter.setLifespan(1000);
                this.emitter.setTint(0xffd700, 0xff0000); // é‡‘è‰²å’Œç´…è‰²
                this.emitter.start();
                // è®“ç™¼å°„å™¨è·Ÿéš¨æ»‘é¼ æœƒæœ‰ä»™å¥³æ£’æ•ˆæœ
                this.input.on('pointermove', (pointer) => {
                    if(currentThemeKey === 'newyear') this.emitter.setPosition(pointer.x, pointer.y);
                });
            } else {
                // ç”Ÿæ—¥å½©å¸¶
                this.emitter.setTexture('particle_white');
                this.emitter.setPosition({ min: 0, max: this.scale.width }, -50);
                this.emitter.setSpeedY({ min: 100, max: 200 });
                this.emitter.setGravityY(50);
                this.emitter.setTint(0xff0000, 0x00ff00, 0x0000ff, 0xffff00);
                this.emitter.start();
            }
        }

        // --- æ ¸å¿ƒï¼šç”Ÿæˆè²¼ç´™ (Juicy Effect) ---
        spawnSticker(textureKey, startX, startY) {
            // éš¨æ©Ÿä½ç½® (å¦‚æœæ˜¯åœ¨é¸å–®é»æ“Šï¼Œå°±éš¨æ©Ÿæ”¾åœ¨å¡ç‰‡å€)
            let targetX, targetY;
            const sidebarWidth = this.scale.width * 0.25;
            
            if (startX < sidebarWidth) {
                // é»æ“Šç”Ÿæˆçš„
                targetX = sidebarWidth + 50 + Math.random() * (this.scale.width - sidebarWidth - 100);
                targetY = 100 + Math.random() * (this.scale.height - 200);
            } else {
                // æš«æ™‚ä¸æœƒç”¨åˆ°ï¼Œé™¤éåšæ‹–æ›³ç”Ÿæˆ
                targetX = startX; targetY = startY;
            }

            // å»ºç«‹ Sprite
            const sprite = this.add.image(targetX, targetY, textureKey);
            
            // éš¨æ©Ÿå¤§å°
            const randomScale = 0.8 + Math.random() * 0.5;
            sprite.setScale(0); // ä¸€é–‹å§‹æ˜¯ 0ï¼Œç‚ºäº†åšå½ˆå‡ºå‹•ç•«

            // åŠ å…¥ç¾¤çµ„
            this.stickersGroup.add(sprite);

            // å•Ÿç”¨äº’å‹•èˆ‡æ‹–æ›³
            sprite.setInteractive({ draggable: true });
            
            // å½ˆå‡ºå‹•ç•« (Pop Tween)
            this.tweens.add({
                targets: sprite,
                scale: randomScale,
                duration: 600,
                ease: 'Elastic.easeOut' // å½ˆæ€§æ•ˆæœ
            });

            // æ‹–æ›³é‚è¼¯
            sprite.on('dragstart', () => {
                this.children.bringToTop(sprite); // æ‹‰åˆ°æœ€ä¸Šå±¤
                this.tweens.add({ targets: sprite, scale: randomScale * 1.2, duration: 100 }); // æ‹¿èµ·ä¾†è®Šå¤§
            });

            sprite.on('drag', (pointer, dragX, dragY) => {
                sprite.x = dragX;
                sprite.y = dragY;
            });

            sprite.on('dragend', () => {
                // åˆ¤æ–·æ˜¯å¦ä¸Ÿå›é¸å–®å€ (åˆªé™¤)
                if (sprite.x < this.scale.width * 0.25) {
                    this.tweens.add({
                        targets: sprite, scale: 0, duration: 200,
                        onComplete: () => sprite.destroy()
                    });
                } else {
                    // æ”¾ä¸‹æ™‚çš„ç‰¹æ•ˆ
                    this.tweens.add({ targets: sprite, scale: randomScale, duration: 200 });
                }
            });
        }

        resize(gameSize) {
            const w = gameSize.width;
            const h = gameSize.height;
            
            // èª¿æ•´èƒŒæ™¯èˆ‡UIå¤§å°
            this.bgTile.setSize(w, h);
            this.sidebarBg.setSize(w*0.25, h-80);
            this.sidebarBorder.x = w*0.25;
            this.sidebarBorder.height = h-80;
            this.greetingText.setPosition(w*0.6, h*0.5);
        }

        update() {
            // è®“èƒŒæ™¯ç´‹ç†ç·©æ…¢ç§»å‹• (Parallax Effect)
            this.bgTile.tilePositionX += 0.5;
            this.bgTile.tilePositionY += 0.5;
        }
    }
</script>
</body>
</html>
