<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- App å½è£æ¨¡å¼è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è³€å¡è£½ä½œ">

    <title>ç¯€æ—¥è³€å¡è£½ä½œæ©Ÿ v14.0 iPhoneä¿®å¾©ç‰ˆ</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { 
            margin: 0; padding: 0; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            overflow: hidden; 
            display: flex; flex-direction: column; 
            height: 100vh; 
            background-color: #333; 
            touch-action: none; 
            -webkit-user-select: none; user-select: none;
        }

        /* --- é–‹å§‹ç•«é¢ --- */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            color: white;
            transition: opacity 0.5s;
        }

        .start-box {
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            max-width: 80%;
        }

        .start-box h1 { margin: 0 0 20px 0; font-size: 3rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .start-box p { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; line-height: 1.6; }
        .warning-text { color: #ffeb3b; font-weight: bold; }

        #start-btn {
            font-size: 2rem; padding: 15px 50px;
            border: none; border-radius: 50px;
            background-color: #ffeb3b; color: #333;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s;
            animation: pulse 2s infinite;
        }
        #start-btn:active { transform: scale(0.95); }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* --- é ‚éƒ¨ä¸»é¡Œé¸æ“‡å€ --- */
        #top-bar {
            height: 80px; background-color: #fff;
            display: flex; justify-content: center; align-items: center;
            gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100;
            padding-top: env(safe-area-inset-top); flex-shrink: 0;
        }

        .theme-btn {
            font-size: 1.1rem; padding: 8px 20px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
            white-space: nowrap;
        }
        .theme-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-xmas { background-color: #2e7d32; }
        .btn-newyear { background-color: #d32f2f; }
        .btn-bday { background-color: #f06292; }

        /* --- ä¸»å·¥ä½œå€ --- */
        #workspace { 
            display: flex; flex: 1; overflow: hidden; 
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
        }

        /* --- å·¦å´é¸å–® --- */
        #sidebar { 
            width: 28%; background-color: #f5f5f5; border-right: 5px solid #ddd; 
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 10px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            z-index: 20;
        }

        .mode-controls { display: flex; gap: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .mode-btn { 
            padding: 8px 12px; border-radius: 8px; border: 2px solid #555; 
            background: white; font-size: 1rem; cursor: pointer; font-weight: bold; 
        }
        .mode-btn.active { background: #555; color: white; }

        /* é›™æ’é¡¯ç¤ºè²¼ç´™ */
        #sticker-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 95%;
            padding-bottom: 40px; 
            justify-items: center;
            align-content: start;
        }

        .sticker-container { 
            display: flex; flex-direction: column; align-items: center; 
            margin: 5px 0; flex-shrink: 0; 
        }
        
        .sticker-source { 
            font-size: 4rem; cursor: grab; line-height: 1; transition: transform 0.1s; 
        }
        .sticker-source:active { transform: scale(1.2); }
        .sticker-label { font-size: 0.9rem; color: #555; margin-top: 2px; font-weight: bold; }

        /* --- å³å´è³€å¡å€ (å¢åŠ èƒŒæ™¯æ¨£å¼) --- */
        #card-area { 
            position: relative; width: 72%; height: 100%; 
            background-color: white; 
            box-shadow: inset 0 0 30px rgba(0,0,0,0.1); 
            overflow: hidden; 
            transition: background 0.3s; /* èƒŒæ™¯åˆ‡æ›å‹•ç•« */
        }

        /* èƒŒæ™¯æ¨£å¼ */
        .bg-pattern-xmas {
            background-color: #e8f5e9;
            background-image: repeating-linear-gradient(45deg, #c8e6c9 0px, #c8e6c9 20px, #ffffff 20px, #ffffff 40px);
        }
        .bg-pattern-newyear {
            background-color: #ffcdd2;
            background-image: radial-gradient(circle, #fbc02d 15%, transparent 16%), radial-gradient(circle, #fbc02d 15%, transparent 16%);
            background-size: 50px 50px; background-position: 0 0, 25px 25px;
        }
        .bg-pattern-birthday {
            background-color: #f3e5f5;
            background-image: radial-gradient(#e1bee7 20%, transparent 20%), radial-gradient(#ce93d8 20%, transparent 20%);
            background-size: 40px 40px; background-position: 0 0, 20px 20px;
        }

        #text-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 40px; box-sizing: border-box;
        }

        .text-field { font-size: 1.5rem; color: #444; font-weight: bold; opacity: 0.8; text-shadow: 1px 1px 0 rgba(255,255,255,0.8); }
        .dashed-line { border-bottom: 3px dashed #555; display: inline-block; width: 200px; margin-left: 10px; }
        
        #greeting-text {
            text-align: center; font-size: 4rem; font-weight: 900; 
            text-shadow: 3px 3px 0px rgba(255,255,255,0.9), 0 0 20px rgba(255,255,255,0.8);
            color: #333; margin-top: -50px; line-height: 1.2;
        }

        #drawing-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; touch-action: none; }
        
        .placed-sticker { 
            position: absolute; 
            z-index: 10; cursor: move; touch-action: none; 
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        #clear-btn { 
            position: absolute; bottom: 20px; right: 20px; 
            background-color: #ff5252; color: white; border: none; 
            padding: 15px 30px; border-radius: 50px; font-size: 1.5rem; 
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 20; 
        }
        #clear-btn:active { transform: scale(0.95); }

        /* ã€æ–°åŠŸèƒ½ã€‘éŸ³æ¨‚é–‹é—œæŒ‰éˆ• */
        #music-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #555; border-radius: 50%;
            width: 50px; height: 50px;
            font-size: 1.5rem; cursor: pointer; z-index: 50;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #music-btn:active { transform: scale(0.9); }

        /* --- æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ --- */
        @media (max-width: 768px) {
            .start-box h1 { font-size: 2rem; }
            .start-box p { font-size: 1rem; }
            #start-btn { font-size: 1.5rem; padding: 12px 40px; }
            
            #top-bar { height: 60px; gap: 10px; }
            .theme-btn { font-size: 0.9rem; padding: 6px 12px; }
            #workspace { flex-direction: column-reverse; }

            #sidebar { 
                width: 100%; height: 160px; 
                border-right: none; border-top: 5px solid #ddd;
                flex-direction: row; padding: 5px; align-items: center; overflow-x: auto;
            }

            .mode-controls { 
                flex-direction: column; margin-bottom: 0; margin-right: 10px; transform: scale(0.9);
            }
            .mode-btn { padding: 5px 8px; font-size: 0.9rem; }

            #sticker-list {
                display: flex; flex-direction: row; flex-wrap: wrap; 
                justify-content: center; gap: 8px; width: 100%; height: 100%; align-content: center;
            }
            
            .sticker-source { font-size: 3rem; }
            .sticker-label { display: none; }

            #card-area { width: 100%; flex: 1; }
            #text-overlay { padding: 20px; }
            #greeting-text { font-size: 2.5rem; margin-top: -20px; }
            .text-field { font-size: 1rem; }
            .dashed-line { width: 100px; }
            
            #clear-btn { padding: 10px 20px; font-size: 1.2rem; bottom: 10px; right: 10px; }
            #music-btn { top: 10px; right: 10px; width: 40px; height: 40px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <!-- éŸ³æ¨‚æ’­æ”¾å™¨ -->
    <audio id="bgm-player" loop></audio>

    <!-- é–‹å§‹ç•«é¢ Overlay -->
    <div id="start-overlay">
        <div class="start-box">
            <h1>âœ¨ ç¯€æ—¥è³€å¡è£½ä½œæ©Ÿ âœ¨</h1>
            <p>
                âš ï¸ <b>iPhone/iPad ç”¨æˆ¶è«‹æ³¨æ„</b> âš ï¸<br>
                è«‹ç¢ºèª <span class="warning-text">æ©Ÿèº«å·¦å´éœéŸ³éµ</span> å·²é—œé–‰<br>
                (ä¸è¦çœ‹åˆ°ç´…è‰²)ï¼Œå¦å‰‡æœƒæ²’æœ‰è²éŸ³ï¼
            </p>
            <button id="start-btn" onclick="startApp()">é–‹å§‹è£½ä½œ â–¶ï¸</button>
        </div>
    </div>

    <div id="top-bar">
        <button class="theme-btn btn-xmas" onclick="changeTheme('christmas')">ğŸ„ è–èª•å¡</button>
        <button class="theme-btn btn-newyear" onclick="changeTheme('newyear')">ğŸ§§ æ–°å¹´å¡</button>
        <button class="theme-btn btn-bday" onclick="changeTheme('birthday')">ğŸ‚ ç”Ÿæ—¥å¡</button>
    </div>

    <div id="workspace">
        <div id="sidebar">
            <div class="mode-controls">
                <button id="mode-sticker" class="mode-btn active" onclick="setMode('sticker')">ğŸ–ï¸ è²¼ç´™</button>
                <button id="mode-draw" class="mode-btn" onclick="setMode('draw')">ğŸ–ï¸ ç•«ç•«</button>
            </div>
            <div id="sticker-list"></div>
        </div>

        <div id="card-area">
            <!-- éŸ³æ¨‚æ‰‹å‹•é–‹é—œ -->
            <button id="music-btn" onclick="toggleMusic()">ğŸµ</button>

            <div id="text-overlay">
                <div class="text-field" style="text-align: left;">To:<span class="dashed-line"></span></div>
                <div id="greeting-text">MERRY CHRISTMAS</div>
                <div class="text-field" style="text-align: right;">From:<span class="dashed-line"></span></div>
            </div>
            <canvas id="drawing-canvas"></canvas>
            <button id="clear-btn" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤é‡ä¾†</button>
        </div>
    </div>

    <script>
        function startApp() {
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-overlay').style.display = 'none';
            }, 500);

            const audioPlayer = document.getElementById('bgm-player');
            const data = themes[currentTheme]; 
            if (data && data.music) {
                audioPlayer.src = data.music;
                // åŠ å…¥ load() å¹«åŠ© iPhone æº–å‚™
                audioPlayer.load();
                audioPlayer.play().then(() => {
                    console.log("éŸ³æ¨‚æ’­æ”¾æˆåŠŸ");
                    updateMusicBtnState(true);
                }).catch(e => {
                    console.log("è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ï¼Œç­‰å¾…ä½¿ç”¨è€…æ‰‹å‹•æ’­æ”¾", e);
                    updateMusicBtnState(false);
                });
            }

            const utterance = new SpeechSynthesisUtterance(" ");
            window.speechSynthesis.speak(utterance);
        }

        // --- æ‰‹å‹•æ§åˆ¶éŸ³æ¨‚ ---
        function toggleMusic() {
            const player = document.getElementById('bgm-player');
            if (player.paused) {
                player.play();
                updateMusicBtnState(true);
            } else {
                player.pause();
                updateMusicBtnState(false);
            }
        }

        function updateMusicBtnState(isPlaying) {
            const btn = document.getElementById('music-btn');
            if (isPlaying) {
                btn.textContent = "ğŸµ";
                btn.style.opacity = "1";
            } else {
                btn.textContent = "ğŸ”‡"; // éœéŸ³åœ–ç¤º
                btn.style.opacity = "0.6";
            }
        }

        let currentTheme = 'christmas'; 

        function speakText(text) {
            if (!text) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-HK'; 
            utterance.rate = 1.0; 
            utterance.pitch = 1.3; 
            
            const voices = window.speechSynthesis.getVoices();
            const hkVoice = voices.find(v => v.lang.includes('zh-HK') || v.lang.includes('Cantonese'));
            if (hkVoice) utterance.voice = hkVoice;
            
            window.speechSynthesis.speak(utterance);
        }
        window.speechSynthesis.onvoiceschanged = function() { window.speechSynthesis.getVoices(); };

        const themes = {
            'christmas': {
                greeting: 'MERRY CHRISTMAS', speechName: 'è–èª•å¿«æ¨‚',
                bgClass: 'bg-pattern-xmas', 
                border: '10px solid #c62828', textColor: '#2e7d32', 
                music: 'https://ia800504.us.archive.org/13/items/JingleBells_208/JingleBells.mp3', 
                stickers: [ 
                    { icon: 'ğŸ…', name: 'è–èª•è€äºº' }, { icon: 'ğŸ„', name: 'è–èª•æ¨¹' }, 
                    { icon: 'â›„', name: 'é›ªäºº' }, { icon: 'ğŸ¦Œ', name: 'é¹¿ä»”' }, 
                    { icon: 'ğŸ', name: 'ç¦®ç‰©' }, { icon: 'â„ï¸', name: 'é›ªèŠ±' }, 
                    { icon: 'ğŸ””', name: 'å®å®é˜' }, { icon: 'ğŸª', name: 'æ›²å¥‡' },
                    { icon: 'ğŸ§¦', name: 'è–èª•è¥ª' }, { icon: 'ğŸ•¯ï¸', name: 'è Ÿç‡­' },
                    { icon: 'â­', name: 'æ˜Ÿæ˜Ÿ' }, { icon: 'ğŸ‘¼', name: 'å¤©ä½¿' },
                    { icon: 'ğŸ«', name: 'æœ±å¤åŠ›' }, { icon: 'ğŸ¡', name: 'é›ªå±‹' }
                ]
            },
            'newyear': {
                greeting: 'æ–° å¹´ å¿« æ¨‚', speechName: 'æ–°å¹´å¿«æ¨‚',
                bgClass: 'bg-pattern-newyear', 
                border: '10px solid #fbc02d', textColor: '#d32f2f', 
                music: 'https://ia801601.us.archive.org/6/items/ChineseNewYearMusic/Chinese%20New%20Year%20Music.mp3', 
                stickers: [ 
                    { icon: 'ğŸ§§', name: 'åˆ©æ˜¯' }, { icon: 'ğŸ®', name: 'ç‡ˆç± ' }, 
                    { icon: 'ğŸ§¨', name: 'ç‚®ä»—' }, { icon: 'ğŸŠ', name: 'å¤§å‰' }, 
                    { icon: 'ğŸ¦', name: 'é†’ç…' }, { icon: 'âœ¨', name: 'ç…™èŠ±' }, 
                    { icon: 'ğŸ‰', name: 'é¾' }, { icon: 'ğŸ’°', name: 'å…ƒå¯¶' },
                    { icon: 'ğŸŒ¸', name: 'æ¡ƒèŠ±' }, { icon: 'ğŸ¥Ÿ', name: 'é¤ƒå­' },
                    { icon: 'ğŸŸ', name: 'å¹´å¹´æœ‰é­š' }, { icon: 'ğŸª­', name: 'æ‰‡' },
                    { icon: 'ğŸ', name: 'è è˜¿' }, { icon: 'ğŸ–Œï¸', name: 'æ®æ˜¥' }
                ]
            },
            'birthday': {
                greeting: 'HAPPY BIRTHDAY', speechName: 'ç”Ÿæ—¥å¿«æ¨‚',
                bgClass: 'bg-pattern-birthday', 
                border: '10px solid #ba68c8', textColor: '#7b1fa2', 
                music: 'https://ia800806.us.archive.org/19/items/HappyBirthdayToYou_442/Happy_Birthday_to_You.mp3', 
                stickers: [ 
                    { icon: 'ğŸ‚', name: 'ç”Ÿæ—¥è›‹ç³•' }, { icon: 'ğŸˆ', name: 'æ°£çƒ' }, 
                    { icon: 'ğŸ‰', name: 'æ‹‰ç‚®' }, { icon: 'ğŸ•¯ï¸', name: 'è Ÿç‡­' }, 
                    { icon: 'ğŸ‘‘', name: 'çš‡å† ' }, { icon: 'ğŸ', name: 'ç¦®ç‰©' }, 
                    { icon: 'ğŸ°', name: 'è›‹ç³•' }, { icon: 'ğŸ¥³', name: 'é–‹å¿ƒ' },
                    { icon: 'ğŸ§', name: 'æ¯å­è›‹ç³•' }, { icon: 'ğŸ•', name: 'è–„é¤…' },
                    { icon: 'ğŸ­', name: 'æ³¢æ¿ç³–' }, { icon: 'ğŸ¦', name: 'é›ªç³•' },
                    { icon: 'ğŸ§¸', name: 'å•¤å•¤ç†Š' }, { icon: 'ğŸµ', name: 'éŸ³æ¨‚' }
                ]
            }
        };

        let currentMode = 'sticker'; let isDragging = false; let isDrawing = false; let lastX = 0; let lastY = 0;
        const canvas = document.getElementById('drawing-canvas'); const ctx = canvas.getContext('2d'); const cardArea = document.getElementById('card-area'); const stickerList = document.getElementById('sticker-list'); const audioPlayer = document.getElementById('bgm-player'); const greetingText = document.getElementById('greeting-text');

        function resizeCanvas() { canvas.width = cardArea.offsetWidth; canvas.height = cardArea.offsetHeight; }
        window.addEventListener('resize', resizeCanvas);
        document.body.addEventListener('touchmove', function(e) { 
            if (!e.target.closest('#sidebar')) { e.preventDefault(); }
        }, { passive: false });

        setupTheme('christmas');

        function changeTheme(themeKey) {
            setupTheme(themeKey);
            // åªæœ‰ç•¶é–‹å§‹ç•«é¢å·²ç¶“æ¶ˆå¤±ï¼Œä¸”éŸ³æ¨‚é–‹é—œæ˜¯é–‹å•Ÿçš„ç‹€æ…‹ä¸‹ï¼Œæ‰å˜—è©¦è‡ªå‹•æ’­æ”¾
            if (document.getElementById('start-overlay').style.display === 'none') {
                speakText(themes[themeKey].speechName);
                const data = themes[themeKey];
                
                // æª¢æŸ¥ç›®å‰çš„éŸ³æ¨‚æŒ‰éˆ•ç‹€æ…‹ï¼Œå¦‚æœæ˜¯éœéŸ³(muted)ï¼Œå°±ä¸è¦è‡ªå‹•æ’­æ”¾
                const btnText = document.getElementById('music-btn').textContent;
                
                if (data.music && btnText === "ğŸµ") { 
                    audioPlayer.src = data.music; 
                    audioPlayer.play().catch(e => { console.log("åˆ‡æ›ä¸»é¡Œè‡ªå‹•æ’­æ”¾å¤±æ•—"); }); 
                } else {
                    // å¦‚æœæ²’æœ‰éŸ³æ¨‚é€£çµï¼Œæˆ–è€…ä½¿ç”¨è€…å·²ç¶“æ‰‹å‹•é—œé–‰éŸ³æ¨‚
                    if(!data.music) audioPlayer.pause();
                }
            }
        }

        function setupTheme(themeKey) {
            currentTheme = themeKey;
            const data = themes[themeKey];
            
            cardArea.className = ''; 
            if (data.bgClass) {
                cardArea.classList.add(data.bgClass);
            }
            
            cardArea.style.border = data.border;
            greetingText.textContent = data.greeting; greetingText.style.color = data.textColor;
            document.querySelectorAll('.text-field').forEach(el => el.style.color = data.textColor);
            document.querySelectorAll('.dashed-line').forEach(el => el.style.borderBottomColor = data.textColor);
            
            stickerList.innerHTML = '';
            data.stickers.forEach(item => {
                const container = document.createElement('div'); container.className = 'sticker-container';
                const source = document.createElement('div'); source.className = 'sticker-source';
                source.textContent = item.icon; source.setAttribute('data-speech', item.name); source.addEventListener('pointerdown', handlePointerDown);
                const label = document.createElement('span'); label.className = 'sticker-label'; label.textContent = item.name;
                container.appendChild(source); container.appendChild(label); stickerList.appendChild(container);
            });
            clearAll(); 
        }

        function getRandomSize() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                return (Math.random() * (5 - 3) + 3) + 'rem';
            } else {
                return (Math.random() * (7.5 - 4) + 4) + 'rem';
            }
        }

        function handlePointerDown(e) {
            if (currentMode !== 'sticker') return;
            e.preventDefault(); 
            const source = e.target; 
            speakText(source.getAttribute('data-speech'));
            
            const clone = document.createElement('div'); 
            clone.textContent = source.textContent; 
            clone.className = 'placed-sticker';
            clone.style.fontSize = getRandomSize();
            
            // åˆå§‹è¨­å®šåœ¨æ‰‹æŒ‡ä½ç½®
            clone.style.left = e.clientX + 'px'; 
            clone.style.top = e.clientY + 'px'; 
            clone.style.transform = 'translate(-50%, -50%)';
            
            document.body.appendChild(clone); 
            startDrag(clone, e);
        }

        function startDrag(element, startEvent) {
            isDragging = true; 
            document.addEventListener('pointermove', onMove); 
            document.addEventListener('pointerup', onUp);
            
            function onMove(e) { 
                if (!isDragging) return; 
                element.style.left = e.clientX + 'px'; 
                element.style.top = e.clientY + 'px'; 
            }

            function onUp(e) {
                isDragging = false; 
                document.removeEventListener('pointermove', onMove); 
                document.removeEventListener('pointerup', onUp);
                
                const sidebarRect = document.getElementById('sidebar').getBoundingClientRect();
                const isInSidebar = e.clientX >= sidebarRect.left && 
                                    e.clientX <= sidebarRect.right && 
                                    e.clientY >= sidebarRect.top && 
                                    e.clientY <= sidebarRect.bottom;
                
                const dist = Math.hypot(e.clientX - startEvent.clientX, e.clientY - startEvent.clientY);
                const isTap = dist < 20;

                if (isInSidebar) { 
                    if (isTap) {
                        const rect = cardArea.getBoundingClientRect();
                        const padding = 50; 
                        const randomX = padding + Math.random() * (rect.width - 2 * padding);
                        const randomY = padding + Math.random() * (rect.height - 2 * padding);
                        
                        element.style.left = randomX + 'px';
                        element.style.top = randomY + 'px';
                        cardArea.appendChild(element); 
                        attachDragEvent(element);
                    } else {
                        element.remove(); 
                    }
                } else {
                    const rect = cardArea.getBoundingClientRect(); 
                    element.style.left = (e.clientX - rect.left) + 'px'; 
                    element.style.top = (e.clientY - rect.top) + 'px';
                    cardArea.appendChild(element);
                    attachDragEvent(element);
                }
            }
        }

        function attachDragEvent(element) {
            element.addEventListener('pointerdown', (ev) => {
                if(currentMode === 'sticker') { 
                    ev.preventDefault(); 
                    const rect = cardArea.getBoundingClientRect();
                    element.style.left = ev.clientX + 'px'; 
                    element.style.top = ev.clientY + 'px'; 
                    document.body.appendChild(element); 
                    startDrag(element, ev); 
                }
            });
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('mode-sticker').className = mode === 'sticker' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('mode-draw').className = mode === 'draw' ? 'mode-btn active' : 'mode-btn';
        }

        function getPos(e) { const rect = canvas.getBoundingClientRect(); return { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
        canvas.addEventListener('pointerdown', (e) => { if (currentMode !== 'draw') return; isDrawing = true; const pos = getPos(e); lastX = pos.x; lastY = pos.y; });
        canvas.addEventListener('pointermove', (e) => {
            if (!isDrawing || currentMode !== 'draw') return; const pos = getPos(e);
            ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.strokeStyle = '#ff4081'; ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.stroke(); lastX = pos.x; lastY = pos.y;
        });
        window.addEventListener('pointerup', () => { isDrawing = false; });
        function clearAll() { ctx.clearRect(0, 0, canvas.width, canvas.height); document.querySelectorAll('.placed-sticker').forEach(s => s.remove()); speakText("æ¸…é™¤é‡ä¾†"); }
        resizeCanvas();
    </script>
</body>
</html>
